{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="flex min-h-screen bg-gradient-to-b from-gray-50 to-gray-100">
  <aside class="w-64 bg-white shadow-md p-6 border-r border-gray-200">
    <h2 class="text-xl font-semibold text-gray-800 mb-6">Community</h2>
    <nav class="space-y-3">
      <button id="showAllBtn" 
        class="sidebar-btn w-full text-left px-3 py-2 rounded-lg hover:bg-blue-50 transition text-gray-700 font-medium active">
        üè† All Posts
      </button>
      <button id="showYourBtn" 
        class="sidebar-btn w-full text-left px-3 py-2 rounded-lg hover:bg-blue-50 transition text-gray-700 font-medium">
        ‚úçÔ∏è Your Posts
      </button>
      <button id="showLikedBtn" 
        class="sidebar-btn w-full text-left px-3 py-2 rounded-lg hover:bg-blue-50 transition text-gray-700 font-medium">
        ‚ù§Ô∏è Liked Posts
      </button>
    </nav>
  </aside>

  <main class="flex-1 p-8">
    <div class="flex justify-between items-center mb-8">
      <h1 class="text-3xl font-bold text-gray-800">Community Space</h1>
      <p class="text-gray-500">Share your progress and learn from others</p>
    </div>

    <div class="bg-white shadow-md rounded-2xl p-6 mb-10">
      <h2 class="text-lg font-semibold text-gray-700 mb-3">Share your thoughts</h2>
      <textarea id="postContent" rows="3" placeholder="What's on your mind?" 
        class="w-full border border-gray-200 rounded-lg p-3 focus:ring-2 focus:ring-blue-200 focus:outline-none"></textarea>

      <div class="flex justify-between items-center mt-3">
        <div class="flex items-center gap-3">
          <select id="linkedType" class="border rounded-lg px-3 py-2 text-sm text-gray-600">
            <option value="">Attach...</option>
            <option value="goal">Goal</option>
            <option value="transaction">Transaction</option>
          </select>

          <select id="linkedSelect" class="border rounded-lg px-3 py-2 text-sm text-gray-600 hidden w-48">
            <option value="">Select one...</option>
          </select>
        </div>

        <button id="createPostBtn" 
          class="bg-blue-500 text-white px-5 py-2 rounded-lg hover:bg-blue-600 transition">
          Share
        </button>
      </div>
    </div>

    <div id="communityFeed" class="space-y-6">
      <p class="text-gray-500">Loading posts...</p>
    </div>
  </main>
</div>

<script>
const token = localStorage.getItem('access');
if (!token) window.location.href = '/users/login/';

let currentUser = null;
let currentFilter = "all";

async function getCurrentUser() {
  const res = await fetch('/api/users/me/', { headers: { Authorization: `Bearer ${token}` } });
  if (res.ok) currentUser = await res.json();
}

const linkedType = document.getElementById("linkedType");
const linkedSelect = document.getElementById("linkedSelect");

linkedType.addEventListener("change", async () => {
  const type = linkedType.value;
  linkedSelect.innerHTML = `<option value="">Select one...</option>`;
  linkedSelect.classList.add("hidden");
  if (!type) return;

  const url = type === "goal" ? "/api/core/goals/" : "/api/core/transactions/";
  const res = await fetch(url, { headers: { "Authorization": `Bearer ${token}` } });
  if (!res.ok) return alert("Failed to load your " + type + "s.");
  const data = await res.json();

  if (data.length === 0) {
    linkedSelect.innerHTML = `<option value="">No ${type}s available</option>`;
  } else {
    data.forEach(item => {
      linkedSelect.innerHTML += type === "goal"
        ? `<option value="${item.id}">${item.title} ‚Äî $${item.target_amount}</option>`
        : `<option value="${item.id}">${item.category} ‚Äî $${item.amount}</option>`;
    });
  }
  linkedSelect.classList.remove("hidden");
});

document.getElementById("createPostBtn").addEventListener("click", async () => {
  const content = document.getElementById("postContent").value.trim();
  const type = linkedType.value;
  const selectedId = linkedSelect.value;

  if (!content) return alert("Post content cannot be empty.");

  const body = { content };
  if (type && selectedId) body[`shared_${type}`] = selectedId;

  console.log(body)

  const res = await fetch("/api/community/posts/", {
    method: "POST",
    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
    body: JSON.stringify(body),
  });

  if (res.ok) {
    document.getElementById("postContent").value = "";
    linkedType.value = "";
    linkedSelect.classList.add("hidden");
    loadPosts();
  } else {
    alert("Failed to post. Please try again.");
  }
});

async function loadPosts() {
  let url = "/api/community/posts/";
  if (currentFilter === "your") url = "/api/community/posts/mine/";
  else if (currentFilter === "liked") url = "/api/community/posts/liked/";

  const feed = document.getElementById("communityFeed");
  feed.innerHTML = `<p class="text-gray-500">Loading posts...</p>`;

  const res = await fetch(url, { headers: { "Authorization": `Bearer ${token}` } });
  if (!res.ok) {
    feed.innerHTML = `<p class="text-red-500">Error loading posts.</p>`;
    return;
  }

  const posts = await res.json();
  renderPosts(posts);
}

function renderPosts(posts) {
  const feed = document.getElementById("communityFeed");
  feed.innerHTML = "";

  if (!posts.length) {
    feed.innerHTML = `<p class="text-gray-500">No posts to display.</p>`;
    return;
  }

  posts.forEach(post => {
    const div = document.createElement("div");
    div.className = "bg-white p-6 rounded-2xl shadow hover:shadow-lg transition";

    div.innerHTML = `
      <div class="flex justify-between items-center mb-2">
        <p class="font-semibold text-gray-800">
            @${post.author.username}
            <span class="ml-2 text-sm text-blue-600 font-medium">
                (${post.author.savings_rating || "Getting Started"})
            </span>
        </p>
        <span class="text-sm text-gray-400">${new Date(post.created_at).toLocaleString()}</span>
      </div>
      <p class="text-gray-700 mb-3">${post.content}</p>

      ${post.goal ? `
        <div class="bg-blue-50 border border-blue-100 rounded-lg p-3 mb-3 text-sm text-blue-800">
          üéØ Shared Goal: <strong>${post.goal.title}</strong> ‚Äî Target: $${post.goal.target_amount}
        </div>` : ''}

      ${post.transaction ? `
        <div class="bg-green-50 border border-green-100 rounded-lg p-3 mb-3 text-sm text-green-800">
          üí∞ Shared Transaction: ${post.transaction.category} ‚Äî $${post.transaction.amount}
        </div>` : ''}

      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <button onclick="toggleLike(${post.id})" 
            class="flex items-center gap-1 text-gray-600 hover:text-blue-600 transition">
            ‚ù§Ô∏è <span>${post.likes_count || 0}</span>
          </button>
          <button onclick="toggleComments(${post.id})" 
            class="flex items-center gap-1 text-gray-600 hover:text-gray-800 transition">
            üí¨ Comments
          </button>
        </div>

        ${currentUser && currentUser.username === post.author.username ? `
          <button onclick="deletePost(${post.id})" 
            class="text-red-500 hover:text-red-700 text-sm font-medium">
            Delete
          </button>
        ` : ''}
      </div>

      <div id="comments-${post.id}" class="hidden mt-4 border-t pt-3 space-y-3"></div>
    `;
    feed.appendChild(div);
  });
}

async function toggleComments(postId) {
  const section = document.getElementById(`comments-${postId}`);
  if (!section.classList.contains("hidden")) return section.classList.add("hidden");
  section.classList.remove("hidden");
  section.innerHTML = `<p class="text-sm text-gray-500">Loading comments...</p>`;

  const res = await fetch(`/api/community/posts/${postId}/comments/`, {
    headers: { "Authorization": `Bearer ${token}` }
  });
  const comments = await res.json();

  section.innerHTML = `
    <div class="space-y-2">
      ${comments.map(c => `
        <div class="border rounded-lg p-2 text-sm">
          <span class="font-semibold">@${c.author.username}</span> 
          <span class="text-gray-600">${c.content}</span>
        </div>
      `).join('')}
    </div>
    <div class="flex mt-2">
      <input id="commentInput-${postId}" placeholder="Add a comment..." 
        class="flex-1 border rounded-lg px-3 py-1 text-sm focus:ring focus:ring-blue-200" />
      <button onclick="addComment(${postId})" 
        class="ml-2 bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 text-sm">Send</button>
    </div>
  `;
}

async function addComment(postId) {
  const input = document.getElementById(`commentInput-${postId}`);
  const content = input.value.trim();
  if (!content) return;
  await fetch(`/api/community/posts/${postId}/comments/`, {
    method: "POST",
    headers: { "Content-Type": "application/json", "Authorization": `Bearer ${token}` },
    body: JSON.stringify({ content }),
  });
  input.value = "";
  toggleComments(postId);
  toggleComments(postId);
}

async function toggleLike(postId) {
  await fetch(`/api/community/posts/${postId}/like/`, {
    method: "POST",
    headers: { "Authorization": `Bearer ${token}` },
  });
  loadPosts();
}

async function deletePost(postId) {
  if (!confirm("Are you sure you want to delete this post?")) return;
  const res = await fetch(`/api/community/posts/${postId}/`, {
    method: "DELETE",
    headers: { "Authorization": `Bearer ${token}` },
  });
  if (res.ok) loadPosts();
  else alert("Failed to delete post.");
}

function setActive(buttonId) {
  document.querySelectorAll(".sidebar-btn").forEach(btn => {
    btn.classList.remove("bg-blue-500", "text-white");
  });
  const btn = document.getElementById(buttonId);
  btn.classList.add("bg-blue-500", "text-white");
}

document.getElementById("showAllBtn").addEventListener("click", () => {
  currentFilter = "all"; setActive("showAllBtn"); loadPosts();
});
document.getElementById("showYourBtn").addEventListener("click", () => {
  currentFilter = "your"; setActive("showYourBtn"); loadPosts();
});
document.getElementById("showLikedBtn").addEventListener("click", () => {
  currentFilter = "liked"; setActive("showLikedBtn"); loadPosts();
});

(async () => {
  await getCurrentUser();
  loadPosts();
})();
</script>
{% endblock %}
