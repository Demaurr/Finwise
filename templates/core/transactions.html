{% extends 'base.html' %}
{% block content %}
<div class="max-w-6xl mx-auto bg-white shadow-md rounded-2xl mt-10 p-8">
  <h2 class="text-3xl font-bold mb-8 text-center text-gray-800">üí∞ Manage Transactions</h2>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
    <!-- Left: Transaction Form -->
    <div class="bg-gray-50 p-6 rounded-xl shadow-sm border">
      <form id="transactionForm" class="space-y-4">
        <input type="hidden" id="transaction_id">

        <div>
          <label class="block text-sm font-semibold text-gray-600 mb-1">Category</label>
          <select id="category" class="w-full border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
            <option value="Salary">Salary</option>
            <option value="Food">Food</option>
            <option value="Rent">Rent</option>
            <option value="Investment">Investment</option>
            <option value="Transportation">Transportation</option>
            <option value="Entertainment">Entertainment</option>
            <option value="Education">Education</option>
            <option value="Health">Health</option>
            <option value="Other">Other</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-600 mb-1">Type</label>
          <select id="type" class="w-full border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
            <option value="income">Income</option>
            <option value="expense">Expense</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-600 mb-1">Amount</label>
          <input type="number" id="amount" class="w-full border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500" step="0.01" required>
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-600 mb-1">Notes</label>
          <textarea id="notes" class="w-full border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500" rows="3"></textarea>
        </div>

        <div class="flex gap-3">
          <button type="submit" class="flex-1 bg-blue-600 text-white font-medium px-4 py-2 rounded-lg hover:bg-blue-700 transition">
            Save
          </button>
          <button type="button" id="resetBtn" class="flex-1 bg-gray-500 text-white font-medium px-4 py-2 rounded-lg hover:bg-gray-600 transition">
            Reset
          </button>
        </div>
      </form>

      <p id="message" class="mt-4 text-center text-sm font-medium"></p>
    </div>

    <div class="bg-gray-50 p-6 rounded-xl shadow-sm border overflow-y-auto max-h-[600px]">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-semibold text-gray-800">üìã Your Transactions</h3>
        <!-- <button onclick="fetchTransactions()" class="text-blue-600 text-sm hover:underline">Refresh</button> -->
      </div>
      <ul id="transactionList" class="divide-y divide-gray-200 text-gray-700"></ul>
    </div>
  </div>
</div>

<script>
const API_BASE = '/api/core/transactions/';
const LOGIN_URL = '/users/login/';
const REFRESH_URL = '/api/auth/token/refresh/';
const VERIFY_URL = '/api/auth/token/verify/';

let access = localStorage.getItem('access');
let refresh = localStorage.getItem('refresh');

if (!access || !refresh) {
  alert("You must log in first!");
  window.location.href = LOGIN_URL;
}

async function getAccessToken() {
  const verifyRes = await fetch(VERIFY_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ token: access })
  });

  if (!verifyRes.ok) {
    const refreshRes = await fetch(REFRESH_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ refresh })
    });

    if (refreshRes.ok) {
      const data = await refreshRes.json();
      access = data.access;
      localStorage.setItem('access', access);
    } else {
      localStorage.clear();
      alert("Session expired. Please log in again.");
      window.location.href = LOGIN_URL;
    }
  }
  return access;
}

async function fetchTransactions() {
  const accessToken = access;
  const res = await fetch(API_BASE, {
    method: "GET",
    headers: { 'Authorization': `Bearer ${accessToken}` }
  });

  const list = document.getElementById('transactionList');
  list.innerHTML = '';

  if (!res.ok) {
    list.innerHTML = `<li class="text-red-600 text-center py-2">Failed to load transactions.</li>`;
    return;
  }

  const data = await res.json();
  if (!Array.isArray(data) || !data.length) {
    list.innerHTML = `<li class="text-gray-600 text-center py-2">No transactions found.</li>`;
    return;
  }

  data.forEach(tx => {
    list.innerHTML += `
      <li class="py-3 flex justify-between items-center hover:bg-white transition">
        <div>
          <p class="font-semibold text-gray-800">${tx.category} 
            <span class="text-sm text-gray-500">(${tx.type})</span>
          </p>
          <p class="text-gray-700">$${tx.amount} ‚Äî <span class="italic">${tx.notes || 'No notes'}</span></p>
        </div>
        <div class="flex gap-3">
          <button onclick="editTx(${tx.id})" class="text-blue-600 hover:underline">‚úèÔ∏è</button>
          <button onclick="deleteTx(${tx.id})" class="text-red-600 hover:underline">üóë</button>
        </div>
      </li>
    `;
  });
}

async function editTx(id) {
  const accessToken = await getAccessToken();
  const res = await fetch(`${API_BASE}${id}/`, {
    headers: { 'Authorization': `Bearer ${accessToken}` }
  });

  if (!res.ok) return alert("Error loading transaction.");

  const tx = await res.json();
  document.getElementById('transaction_id').value = tx.id;
  document.getElementById('category').value = tx.category;
  document.getElementById('type').value = tx.type;
  document.getElementById('amount').value = tx.amount;
  document.getElementById('notes').value = tx.notes || '';
}

async function deleteTx(id) {
  if (!confirm("Are you sure you want to delete this transaction?")) return;

  const accessToken = await getAccessToken();
  const res = await fetch(`${API_BASE}${id}/`, {
    method: 'DELETE',
    headers: { 'Authorization': `Bearer ${accessToken}` }
  });

  if (res.ok) fetchTransactions();
  else alert("Failed to delete transaction.");
}

document.getElementById('transactionForm').addEventListener('submit', async e => {
  e.preventDefault();

  const id = document.getElementById('transaction_id').value;
  const data = {
    category: document.getElementById('category').value,
    type: document.getElementById('type').value,
    amount: parseFloat(document.getElementById('amount').value),
    notes: document.getElementById('notes').value
  };

  const method = id ? 'PUT' : 'POST';
  const url = id ? `${API_BASE}${id}/` : API_BASE;

  const accessToken = await getAccessToken();
  const res = await fetch(url, {
    method,
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${accessToken}`
    },
    body: JSON.stringify(data)
  });

  const msg = document.getElementById('message');
  if (res.ok) {
    msg.textContent = "Transaction saved successfully!";
    msg.className = "text-green-600 text-center font-medium";
    document.getElementById('transactionForm').reset();
    document.getElementById('transaction_id').value = '';
    fetchTransactions();
  } else {
    msg.textContent = "Error saving transaction.";
    msg.className = "text-red-600 text-center font-medium";
  }
});

document.getElementById('resetBtn').addEventListener('click', () => {
  document.getElementById('transactionForm').reset();
  document.getElementById('transaction_id').value = '';
});

fetchTransactions();
</script>
{% endblock %}
