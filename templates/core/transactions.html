{% extends 'base.html' %}
{% block content %}
<div class="max-w-2xl mx-auto bg-white shadow p-6 rounded-xl mt-10">
  <h2 class="text-2xl font-semibold mb-4 text-center">ðŸ’° Manage Transactions</h2>

  <form id="transactionForm" class="space-y-4">
    <input type="hidden" id="transaction_id">

    <div>
      <label class="block text-sm font-medium">Category</label>
      <select id="category" class="w-full border rounded px-3 py-2">
        <option value="Salary">Salary</option>
        <option value="Food">Food</option>
        <option value="Rent">Rent</option>
        <option value="Investment">Investment</option>
        <option value="Transportation">Transportation</option>
        <option value="Entertainment">Entertainment</option>
        <option value="Education">Education</option>
        <option value="Health">Health</option>
        <option value="Other">Other</option>
      </select>
    </div>

    <div>
      <label class="block text-sm font-medium">Type</label>
      <select id="type" class="w-full border rounded px-3 py-2">
        <option value="income">Income</option>
        <option value="expense">Expense</option>
      </select>
    </div>

    <div>
      <label class="block text-sm font-medium">Amount</label>
      <input type="number" id="amount" class="w-full border rounded px-3 py-2" step="0.01" required>
    </div>

    <div>
      <label class="block text-sm font-medium">Notes</label>
      <textarea id="notes" class="w-full border rounded px-3 py-2"></textarea>
    </div>

    <div class="flex gap-2">
      <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
        Save Transaction
      </button>
      <button type="button" id="resetBtn" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
        Reset
      </button>
    </div>
  </form>

  <p id="message" class="mt-4 text-center text-sm"></p>

  <div class="mt-8">
    <h3 class="text-xl font-semibold mb-2">ðŸ“‹ Your Transactions</h3>
    <ul id="transactionList" class="divide-y divide-gray-200"></ul>
  </div>
</div>

<script>
const API_BASE = '/api/core/transactions/';
const LOGIN_URL = '/users/login/';
const REFRESH_URL = '/api/auth/token/refresh/';
const VERIFY_URL = '/api/auth/token/verify/';

let access = localStorage.getItem('access');
let refresh = localStorage.getItem('refresh');

if (!access || !refresh) {
  alert("You must log in first!");
  window.location.href = LOGIN_URL;
}

async function getAccessToken() {
  const verifyRes = await fetch(VERIFY_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ token: access })
  });

  if (!verifyRes.ok) {
    const refreshRes = await fetch(REFRESH_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ refresh })
    });

    if (refreshRes.ok) {
      const data = await refreshRes.json();
      access = data.access;
      localStorage.setItem('access', access);
    } else {
      localStorage.clear();
      alert("Session expired. Please log in again.");
      window.location.href = LOGIN_URL;
    }
  }
  return access;
}

async function fetchTransactions() {
  // const accessToken = await getAccessToken();
  const accessToken = access;
  const res = await fetch(API_BASE, {
    method: "GET",
    headers: { 'Authorization': `Bearer ${accessToken}` }
  });

  const list = document.getElementById('transactionList');
  list.innerHTML = '';

  if (!res.ok) {
    list.innerHTML = `<li class="text-red-600 text-center py-2">Failed to load transactions.</li>`;
    return;
  }

  const data = await res.json();
  if (!Array.isArray(data) || !data.length) {
    list.innerHTML = `<li class="text-gray-600 text-center py-2">No transactions found.</li>`;
    return;
  }

  data.forEach(tx => {
    list.innerHTML += `
      <li class="py-3 flex justify-between items-center">
        <div>
          <p class="font-semibold">${tx.category} <span class="text-sm text-gray-600">(${tx.type})</span></p>
          <p class="text-gray-700">$${tx.amount} â€” ${tx.notes || 'No notes'}</p>
        </div>
        <div class="flex gap-3">
          <button onclick="editTx(${tx.id})" class="text-blue-600 hover:underline">Edit</button>
          <button onclick="deleteTx(${tx.id})" class="text-red-600 hover:underline">Delete</button>
        </div>
      </li>
    `;
  });
}

async function editTx(id) {
  const accessToken = await getAccessToken();
  const res = await fetch(`${API_BASE}${id}/`, {
    headers: { 'Authorization': `Bearer ${accessToken}` }
  });

  if (!res.ok) return alert("Error loading transaction.");

  const tx = await res.json();
  document.getElementById('transaction_id').value = tx.id;
  document.getElementById('category').value = tx.category;
  document.getElementById('type').value = tx.type;
  document.getElementById('amount').value = tx.amount;
  document.getElementById('notes').value = tx.notes || '';
}

async function deleteTx(id) {
  if (!confirm("Are you sure you want to delete this transaction?")) return;

  const accessToken = await getAccessToken();
  const res = await fetch(`${API_BASE}${id}/`, {
    method: 'DELETE',
    headers: { 'Authorization': `Bearer ${accessToken}` }
  });

  if (res.ok) {
    fetchTransactions();
  } else {
    alert("Failed to delete transaction.");
  }
}

document.getElementById('transactionForm').addEventListener('submit', async e => {
  e.preventDefault();

  const id = document.getElementById('transaction_id').value;
  const data = {
    category: document.getElementById('category').value,
    type: document.getElementById('type').value,
    amount: parseFloat(document.getElementById('amount').value),
    notes: document.getElementById('notes').value
  };

  const method = id ? 'PUT' : 'POST';
  const url = id ? `${API_BASE}${id}/` : API_BASE;

  const accessToken = await getAccessToken();
  const res = await fetch(url, {
    method,
    headers: {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${accessToken}`
    },
    body: JSON.stringify(data)
  });

  const msg = document.getElementById('message');
  if (res.ok) {
    msg.textContent = "Transaction saved successfully!";
    msg.className = "text-green-600 text-center";
    document.getElementById('transactionForm').reset();
    document.getElementById('transaction_id').value = '';
    fetchTransactions();
  } else {
    msg.textContent = "Error saving transaction.";
    msg.className = "text-red-600 text-center";
  }
});

document.getElementById('resetBtn').addEventListener('click', () => {
  document.getElementById('transactionForm').reset();
  document.getElementById('transaction_id').value = '';
});

fetchTransactions();
</script>
{% endblock %}
