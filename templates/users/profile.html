{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="p-8 bg-gradient-to-b from-gray-50 to-gray-100 min-h-screen">
  <div class="flex justify-between items-center mb-8">
    <div>
      <h1 class="text-3xl font-bold text-gray-800">Your Profile</h1>
      <p class="text-gray-500">Manage your personal details, goals, and transactions</p>
    </div>
    <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition">
      Logout
    </button>
  </div>

  <div class="bg-white shadow rounded-2xl p-6 mb-10">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-lg font-semibold text-gray-700">Account Information</h2>
      <div class="space-x-2">
        <button id="editProfileBtn" class="bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 transition">Edit</button>
        <button id="deleteProfileBtn" class="bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 transition">Delete</button>
      </div>
    </div>

    <div id="profileInfo">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
        <div>
          <p class="text-gray-500 text-sm">Username</p>
          <p id="username" class="text-lg font-semibold text-gray-800">Loading...</p>
        </div>
        <div>
          <p class="text-gray-500 text-sm">Full Name</p>
          <p id="profileName" class="text-lg font-semibold text-gray-800">Loading...</p>
        </div>
        <div>
          <p class="text-gray-500 text-sm">Email Address</p>
          <p id="profileEmail" class="text-lg font-semibold text-gray-800">Loading...</p>
        </div>
        <div>
          <p class="text-gray-500 text-sm">Region</p>
          <p id="profileRegion" class="text-lg font-semibold text-gray-800">Loading...</p>
        </div>
        <div>
          <p class="text-gray-500 text-sm">Joined On</p>
          <p id="profileJoined" class="text-lg font-semibold text-gray-800">Loading...</p>
        </div>
        <div>
          <p class="text-gray-500 text-sm">Last Login</p>
          <p id="profileLastLogin" class="text-lg font-semibold text-gray-800">Loading...</p>
        </div>
      </div>
    </div>

    <form id="editProfileForm" class="hidden space-y-4 mt-6">
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
        <div>
          <label class="block text-gray-600 text-sm">First Name</label>
          <input type="text" id="firstName" class="w-full border rounded-lg px-3 py-2 mt-1 focus:ring focus:ring-blue-200" />
        </div>
        <div>
          <label class="block text-gray-600 text-sm">Last Name</label>
          <input type="text" id="lastName" class="w-full border rounded-lg px-3 py-2 mt-1 focus:ring focus:ring-blue-200" />
        </div>
        <div>
          <label class="block text-gray-600 text-sm">Email</label>
          <input type="email" id="email" class="w-full border rounded-lg px-3 py-2 mt-1 focus:ring focus:ring-blue-200" />
        </div>
      </div>

      <div class="flex space-x-3 mt-4">
        <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition">Save</button>
        <button type="button" id="cancelEditBtn" class="bg-gray-300 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-400 transition">Cancel</button>
      </div>
    </form>
  </div>

  <div class="bg-white shadow rounded-2xl p-6 mb-10">
    <h2 class="text-lg font-semibold text-gray-700 mb-4">Change Password</h2>
    <form id="passwordChangeForm" class="space-y-4">
      <div>
        <label class="block text-gray-600 text-sm">Current Password</label>
        <input type="password" id="oldPassword" class="w-full border rounded-lg px-3 py-2 mt-1 focus:ring focus:ring-blue-200" required />
      </div>
      <div>
        <label class="block text-gray-600 text-sm">New Password</label>
        <input type="password" id="newPassword" class="w-full border rounded-lg px-3 py-2 mt-1 focus:ring focus:ring-blue-200" required />
      </div>
      <div>
        <label class="block text-gray-600 text-sm">Confirm New Password</label>
        <input type="password" id="confirmPassword" class="w-full border rounded-lg px-3 py-2 mt-1 focus:ring focus:ring-blue-200" required />
      </div>
      <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition">Update Password</button>
    </form>
  </div>

  <div class="bg-white shadow rounded-2xl p-6 mb-10">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-lg font-semibold text-gray-700">Your Financial Goals</h2>
      <button onclick="window.location.href='/add-goal/'" class="bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 transition">+ Add Goal</button>
    </div>
    <div id="goalsContainer" class="space-y-4"><p class="text-gray-500">Loading goals...</p></div>
  </div>

  <div class="bg-white shadow rounded-2xl p-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-lg font-semibold text-gray-700">Recent Transactions</h2>
      <button onclick="window.location.href='/add-transaction/'" class="bg-green-500 text-white px-3 py-1 rounded-lg hover:bg-green-600 transition">+ Add Transaction</button>
    </div>
    <div class="overflow-x-auto">
      <table class="min-w-full border border-gray-200 rounded-lg">
        <thead class="bg-gray-100">
          <tr>
            <th class="text-left p-3 text-gray-600 font-medium">Date</th>
            <th class="text-left p-3 text-gray-600 font-medium">Category</th>
            <th class="text-left p-3 text-gray-600 font-medium">Description</th>
            <th class="text-left p-3 text-gray-600 font-medium">Amount</th>
          </tr>
        </thead>
        <tbody id="transactionsTable">
          <tr><td colspan="4" class="p-3 text-gray-500">Loading transactions...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
const accessToken = localStorage.getItem("access");
if (!accessToken) window.location.href = "/users/login/";

document.getElementById("logoutBtn").addEventListener("click", () => {
  localStorage.clear();
  window.location.href = "/users/login/";
});

let currentUserId = null;

async function loadProfile() {
  const res = await fetch("/api/users/me/", { headers: { Authorization: `Bearer ${accessToken}` }});
  if (!res.ok) throw new Error("Failed to fetch profile");
  const data = await res.json();

  currentUserId = data.id;
  document.getElementById("username").textContent = `${data.username || ""}`.trim();
  document.getElementById("profileName").textContent = `${data.first_name || ""} ${data.last_name || ""}`.trim();
  document.getElementById("profileEmail").textContent = data.email || "N/A";
  document.getElementById("profileRegion").textContent = data.location?.region || data.location?.country || "Not set";
  document.getElementById("profileJoined").textContent = new Date(data.date_joined).toLocaleDateString();
  document.getElementById("profileLastLogin").textContent = data.last_login ? new Date(data.last_login).toLocaleString() : "Never";

  document.getElementById("firstName").value = data.first_name || "";
  document.getElementById("lastName").value = data.last_name || "";
  document.getElementById("email").value = data.email || "";

  loadGoals();
  loadTransactions();
}

async function loadGoals() {
  const res = await fetch("/api/core/goals/", { headers: { Authorization: `Bearer ${accessToken}` }});
  const container = document.getElementById("goalsContainer");
  if (!res.ok) {
    container.innerHTML = "<p class='text-red-500'>Failed to load goals.</p>";
    return;
  }
  const goals = await res.json();
  if (goals.length === 0) {
    container.innerHTML = "<p class='text-gray-500'>No goals yet.</p>";
    return;
  }
  container.innerHTML = goals.map(goal => `
    <div class="p-4 border rounded-lg flex justify-between items-center hover:bg-gray-50">
      <div>
        <p class="font-semibold text-gray-800">${goal.title}</p>
        <p class="text-sm text-gray-500">Target: $${goal.target_amount} | Saved: $${goal.current_amount}</p>
      </div>
      <span class="text-sm text-gray-400">${goal.deadline ? new Date(goal.deadline).toLocaleDateString() : ""}</span>
    </div>
  `).join("");
}

async function loadTransactions() {
  const res = await fetch("/api/core/transactions/", { headers: { Authorization: `Bearer ${accessToken}` }});
  const table = document.getElementById("transactionsTable");
  if (!res.ok) {
    table.innerHTML = "<tr><td colspan='4' class='p-3 text-red-500'>Failed to load transactions.</td></tr>";
    return;
  }
  const transactions = await res.json();
  if (transactions.length === 0) {
    table.innerHTML = "<tr><td colspan='4' class='p-3 text-gray-500'>No transactions yet.</td></tr>";
    return;
  }
  table.innerHTML = transactions.map(tx => `
    <tr class="border-t hover:bg-gray-50">
      <td class="p-3">${new Date(tx.date).toLocaleDateString()}</td>
      <td class="p-3">${tx.category}</td>
      <td class="p-3">${tx.notes}</td>
      <td class="p-3 font-semibold ${tx.amount < 0 ? 'text-red-500' : 'text-green-600'}">$${tx.amount}</td>
    </tr>
  `).join("");
}

document.getElementById("editProfileBtn").addEventListener("click", () => {
  document.getElementById("profileInfo").classList.add("hidden");
  document.getElementById("editProfileForm").classList.remove("hidden");
});

document.getElementById("cancelEditBtn").addEventListener("click", () => {
  document.getElementById("editProfileForm").classList.add("hidden");
  document.getElementById("profileInfo").classList.remove("hidden");
});

document.getElementById("editProfileForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const payload = {
    first_name: document.getElementById("firstName").value,
    last_name: document.getElementById("lastName").value,
    email: document.getElementById("email").value,
  };

  const res = await fetch(`/api/users/${currentUserId}/`, {
    method: "PATCH",
    headers: { "Content-Type": "application/json", Authorization: `Bearer ${accessToken}` },
    body: JSON.stringify(payload),
  });

  if (res.ok) {
    alert("Profile updated successfully!");
    document.getElementById("editProfileForm").classList.add("hidden");
    document.getElementById("profileInfo").classList.remove("hidden");
    loadProfile();
  } else {
    alert("Error updating profile.");
  }
});

document.getElementById("deleteProfileBtn").addEventListener("click", async () => {
  if (!confirm("Are you sure you want to delete your account? This action cannot be undone.")) return;
  const res = await fetch(`/api/users/${currentUserId}/`, {
    method: "DELETE",
    headers: { Authorization: `Bearer ${accessToken}` },
  });
  if (res.ok) {
    alert("Your account has been deleted.");
    localStorage.clear();
    window.location.href = "/";
  } else {
    alert("Failed to delete account.");
  }
});

document.getElementById("passwordChangeForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const oldPassword = document.getElementById("oldPassword").value;
  const newPassword = document.getElementById("newPassword").value;
  const confirmPassword = document.getElementById("confirmPassword").value;

  if (newPassword !== confirmPassword) {
    alert("New passwords do not match!");
    return;
  }

  const res = await fetch("/api/users/change-password/", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      Authorization: `Bearer ${accessToken}`,
    },
    body: JSON.stringify({
      old_password: oldPassword,
      new_password: newPassword,
    }),
  });

  if (res.ok) {
    alert("Password changed successfully! Please log in again.");
    localStorage.clear();
    window.location.href = "/users/login/";
  } else {
    const data = await res.json();
    alert(data.detail || "Failed to change password.");
  }
});


loadProfile();
</script>
{% endblock %}
